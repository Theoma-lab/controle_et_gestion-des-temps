<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDB Gestion des Temps</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        /* Custom Scrollbar for table */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .btn-yellow {
            background-color: #fbbf24;
            /* Amber-400 */
            color: #1f2937;
            font-weight: 600;
        }

        .btn-yellow:hover {
            background-color: #f59e0b;
        }

        .btn-purple {
            background-color: #4c1d95;
            color: white;
        }

        .badge-collab {
            background-color: #f3e8ff;
            /* Purple 100 */
            color: #6b21a8;
            /* Purple 800 */
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 2px;
        }

        .badge-activity {
            background-color: #fef3c7;
            /* Amber 100 */
            color: #92400e;
            /* Amber 800 */
            border: 1px solid #fcd34d;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .table-header-input {
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            width: 100%;
            margin-top: 4px;
        }

        .table-header-input:focus {
            outline: none;
            border-color: #cbd5e0;
            box-shadow: 0 0 0 2px rgba(226, 232, 240, 0.5);
        }

        th {
            font-weight: 600;
            color: #64748b;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            background-color: #fff;
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 12px 16px;
            font-size: 0.85rem;
            color: #1e293b;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        tr:hover td {
            background-color: #f8fafc;
        }
    </style>
</head>

<body class="text-gray-800 h-screen flex overflow-hidden bg-gray-50">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 z-20">
        <div class="h-16 flex items-center px-6 border-b border-gray-200">
            <h1 class="text-xl font-bold tracking-tight text-gray-900">TDB <span class="text-yellow-500">Gestion
                    Temps</span></h1>
        </div>

        <nav class="flex-1 px-4 py-4 space-y-2">
            <a href="#" onclick="switchView('data')" id="nav-data"
                class="flex items-center gap-3 px-3 py-2 rounded-md transition-colors bg-yellow-50 text-gray-900 font-medium">
                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                    </path>
                </svg>
                Données de base
            </a>
            <a href="#" onclick="switchView('dashboard')" id="nav-dashboard"
                class="flex items-center gap-3 px-3 py-2 rounded-md transition-colors text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                </svg>
                Tableau de Bord
            </a>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <button class="w-full flex items-center gap-2 text-sm text-red-500 hover:text-red-700"
                onclick="sbClient.auth.signOut().then(()=>location.reload())">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                Déconnexion
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">

        <!-- View: DATA GRID -->
        <div id="view-data" class="flex-1 flex flex-col h-full">
            <!-- Header for Data -->
            <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <h2 class="text-lg font-bold">Suivi des Temps</h2>
                    <div
                        class="bg-green-50 text-green-700 px-3 py-1 rounded text-xs font-medium flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Synchro
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button class="btn-yellow px-4 py-2 rounded shadow-sm text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Exporter
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-auto bg-white m-4 rounded-lg border border-gray-200 shadow-sm relative">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th scope="col" style="min-width: 150px;">
                                Client
                                <input type="text" id="filter-client" placeholder="Filtrer..."
                                    class="table-header-input" onkeyup="applyFilters()">
                            </th>
                            <th scope="col" style="min-width: 180px;">
                                Collab
                                <div class="relative">
                                    <button type="button" onclick="toggleDropdown('dd-collab')" id="btn-collab"
                                        class="table-header-input text-left flex justify-between items-center bg-white cursor-pointer relative z-0">
                                        <span id="label-collab" class="truncate block w-full">Tous</span>
                                        <svg class="h-4 w-4 text-gray-400 absolute right-2" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <!-- Dropdown Menu -->
                                    <div id="dd-collab"
                                        class="hidden absolute top-full left-0 w-64 bg-white border border-gray-200 shadow-xl z-50 max-h-60 overflow-y-auto p-2 rounded-md mt-1">
                                        <!-- Checkboxes injected via JS -->
                                    </div>
                                    <!-- Overlay to close -->
                                    <div id="overlay-collab" onclick="toggleDropdown('dd-collab')"
                                        class="hidden fixed inset-0 z-40 bg-transparent cursor-default"></div>
                                </div>
                            </th>
                            <th scope="col" style="min-width: 110px;">
                                <div class="flex items-center justify-between">
                                    <span>Date</span>
                                    <div class="relative">
                                        <button type="button" onclick="toggleDropdown('dd-date')"
                                            class="p-1 hover:bg-gray-200 rounded text-gray-500">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                            </svg>
                                        </button>
                                        <!-- Date Filter Dropdown -->
                                        <div id="dd-date"
                                            class="hidden absolute top-full right-0 w-64 bg-white border border-gray-200 shadow-xl z-50 p-4 rounded-md mt-1">
                                            <div class="space-y-3">
                                                <div>
                                                    <label
                                                        class="block text-xs font-medium text-gray-700 mb-1">Du</label>
                                                    <input type="date" id="filter-date-start"
                                                        class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                                        onchange="applyFilters()">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs font-medium text-gray-700 mb-1">Au</label>
                                                    <input type="date" id="filter-date-end"
                                                        class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                                        onchange="applyFilters()">
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Overlay -->
                                        <div id="overlay-date" onclick="toggleDropdown('dd-date')"
                                            class="hidden fixed inset-0 z-40 bg-transparent cursor-default"></div>
                                    </div>
                                </div>
                            </th>
                            <th scope="col" style="min-width: 200px;">
                                Activité
                                <div class="relative">
                                    <button type="button" onclick="toggleDropdown('dd-activity')" id="btn-activity"
                                        class="table-header-input text-left flex justify-between items-center bg-white cursor-pointer relative z-0">
                                        <span id="label-activity" class="truncate block w-full">Toutes</span>
                                        <svg class="h-4 w-4 text-gray-400 absolute right-2" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <!-- Dropdown Menu -->
                                    <div id="dd-activity"
                                        class="hidden absolute top-full left-0 w-64 bg-white border border-gray-200 shadow-xl z-50 max-h-60 overflow-y-auto p-2 rounded-md mt-1">
                                        <!-- Checkboxes injected via JS -->
                                    </div>
                                    <!-- Overlay to close -->
                                    <div id="overlay-activity" onclick="toggleDropdown('dd-activity')"
                                        class="hidden fixed inset-0 z-40 bg-transparent cursor-default"></div>
                                </div>
                            </th>
                            <th scope="col" style="min-width: 300px;">
                                Commentaire
                                <input type="text" id="filter-comment" placeholder="Recherche..."
                                    class="table-header-input" onkeyup="applyFilters()">
                            </th>
                            <th scope="col" style="min-width: 100px;">
                                Durée (h)
                                <input type="text" id="filter-duration" placeholder="> 0" class="table-header-input"
                                    onkeyup="applyFilters()">
                            </th>
                            <th scope="col" style="min-width: 120px;">
                                Facturable
                                <select id="filter-billable" class="table-header-input" onchange="applyFilters()">
                                    <option value="">Tous</option>
                                    <option value="true">Oui</option>
                                    <option value="false">Non</option>
                                </select>
                            </th>
                            <th scope="col" style="min-width: 150px;">
                                Statut
                                <input type="text" id="filter-status" placeholder="Statut..." class="table-header-input"
                                    onkeyup="applyFilters()">
                            </th>
                        </tr>
                    </thead>
                    <tbody id="timesheet-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="text-center py-10 text-gray-400">Chargement...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700" id="record-count">
                            résultats
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button onclick="changePage(-1)" id="btn-prev"
                                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <!-- Heroicon name: solid/chevron-left -->
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                    fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd"
                                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="page-info"
                                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                Page 1
                            </span>
                            <button onclick="changePage(1)" id="btn-next"
                                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <!-- Heroicon name: solid/chevron-right -->
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                    fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd"
                                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: DASHBOARD -->
        <div id="view-dashboard" class="flex-1 flex flex-col h-full hidden p-6 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                <!-- KPI Cards -->
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium uppercase tracking-wider">Total Heures</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-1" id="kpi-hours">-</h3>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-full text-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium uppercase tracking-wider">Taux Facturable</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-1" id="kpi-billable">- %</h3>
                    </div>
                    <div class="bg-green-50 p-3 rounded-full text-green-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium uppercase tracking-wider">Collaborateurs</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-1" id="kpi-collabs">-</h3>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-full text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium uppercase tracking-wider">Heures Non-Facturables</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-1" id="kpi-non-billable">-</h3>
                    </div>
                    <div class="bg-red-50 p-3 rounded-full text-red-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium uppercase tracking-wider">Client Principal</p>
                        <h3 class="text-lg font-bold text-gray-900 mt-1 truncate" id="kpi-main-client">-</h3>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-full text-yellow-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium uppercase tracking-wider">Jours de Travail</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-1" id="kpi-work-days">-</h3>
                    </div>
                    <div class="bg-indigo-50 p-3 rounded-full text-indigo-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm h-96">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Top 10 Clients (Heures)</h3>
                    <div class="relative h-full w-full">
                        <canvas id="clientChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm h-96">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Évolution Mensuelle</h3>
                    <div class="relative h-full w-full">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm h-96">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Répartition par Collaborateur (Top 10)</h3>
                    <div class="relative h-full w-full">
                        <canvas id="topCollabChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm h-96">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Top 10 Activités</h3>
                    <div class="relative h-full w-full">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const SB_URL = "https://xvqwgndjznvewqgalpaq.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cXdnbmRqem52ZXdxZ2FscGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MjA4NTMsImV4cCI6MjA4NDk5Njg1M30.TlnYV7VgsmV7kOsGlRoFdInLhie8TnLnGOpLMe411ZA";

        const sbClient = supabase.createClient(SB_URL, SB_KEY);

        // Global data cache
        let allTimesheets = [];
        let currentFilteredData = [];
        let currentPage = 1;
        const pageSize = 50;

        function switchView(viewName) {
            // Update Tab Styles
            const navData = document.getElementById('nav-data');
            const navDash = document.getElementById('nav-dashboard');

            if (viewName === 'data') {
                navData.classList.add('bg-yellow-50', 'text-gray-900');
                navData.classList.remove('text-gray-600', 'hover:bg-gray-50');
                navDash.classList.remove('bg-yellow-50', 'text-gray-900');
                navDash.classList.add('text-gray-600', 'hover:bg-gray-50');

                document.getElementById('view-data').classList.remove('hidden');
                document.getElementById('view-dashboard').classList.add('hidden');
            } else {
                navDash.classList.add('bg-yellow-50', 'text-gray-900');
                navDash.classList.remove('text-gray-600', 'hover:bg-gray-50');
                navData.classList.remove('bg-yellow-50', 'text-gray-900');
                navData.classList.add('text-gray-600', 'hover:bg-gray-50');

                document.getElementById('view-data').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');

                // Resize charts
                [window.topCollabChart, window.activityChart, window.clientChart, window.evolutionChart].forEach(c => {
                    if (c) c.resize();
                });
            }
        }

        const EMPLOYEE_NAMES = {
            "alix@theoma.fr": "Alix Sonam",
            "anne-marie@theoma.fr": "Anne-Marie Mendy",
            "nasteho@theoma.fr": "Nasteho Said",
            "hugo@theoma.fr": "Hugo Grellier",
            "caroline@theoma.fr": "Caroline Brillet",
            "anne-cecile@theoma.fr": "Anne-Cecile Joseph",
            "kelly@theoma.fr": "Kelly Gounelle",
            "christ-leroy@theoma.fr": "Christ-Leroy Tsika",
            "alexia@theoma.fr": "Alexia BORDERIE",
            "randy@theoma.fr": "Randy Biswese",
            "natalie@theoma.fr": "Natalie POISSON",
            "coumba@theoma.fr": "Coumba Sylla",
            "leila@theoma.fr": "Leïla Guendouz",
            "sarah@theoma.fr": "Sarah Rhallab",
            "marine@theoma.fr": "Marine CHAILLON",
            "sandra@theoma.fr": "Sandra EMERY",
            "regis@theoma.fr": "Regis GODEFROY",
            "bertille@theoma.fr": "Bertille  COURT",
            "laura@theoma.fr": "Laura BARUK",
            "marion@theoma.fr": "Marion  VIROLLE ",
            "anais@theoma.fr": "Anais DE JESUS",
            "arnaud@theoma.fr": "Arnaud Guichaoua",
            "sanadati@theoma.fr": "Sanadati RIDHOI",
            "fanny@theoma.fr": "Fanny VIROLLET",
            "romain@theoma.fr": "Romain GIPOULOU",
            "kassandra@theoma.fr": "Kassandra  BRUNEAU",
            "stephanie@theoma.fr": "Stéphanie JOLY ",
            "charlotte@theoma.fr": "Charlotte MOULINIER ",
            "lise@theoma.fr": "Lise Massei",
            "alicia@theoma.fr": "Alicia Bejar",
            "melanie@theoma.fr": "Mélanie Voymant"
        };

        function formatName(email) {
            if (!email) return '';

            let fullName = '';
            // 1. Get raw string (from Map or Email)
            if (EMPLOYEE_NAMES[email]) {
                fullName = EMPLOYEE_NAMES[email];
            } else {
                // Fallback: derive from email (jean.dupont -> Jean Dupont)
                const local = email.split('@')[0];
                fullName = local.replace('.', ' ');
            }

            // 2. Force Format: Firstname LASTNAME
            fullName = fullName.trim();
            const parts = fullName.split(/\s+/); // split by whitespace

            if (parts.length === 0) return '';

            // First Name: Title Case
            const firstName = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();

            // Last Name(s): UPPER CASE
            if (parts.length > 1) {
                const lastName = parts.slice(1).join(' ').toUpperCase();
                return `${firstName} ${lastName}`;
            }

            return firstName;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR');
        }

        // --- MULTI-SELECT HELPERS ---
        function toggleDropdown(id) {
            const el = document.getElementById(id);
            const overlay = document.getElementById(id.replace('dd-', 'overlay-'));
            if (el.classList.contains('hidden')) {
                // Hide others first (optional but good UI)
                document.querySelectorAll('[id^=dd-]').forEach(d => d.classList.add('hidden'));
                document.querySelectorAll('[id^=overlay-]').forEach(d => d.classList.add('hidden'));

                el.classList.remove('hidden');
                if (overlay) overlay.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
                if (overlay) overlay.classList.add('hidden');
            }
        }

        function updateLabel(type) {
            const container = document.getElementById(`dd-${type}`);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            const label = document.getElementById(`label-${type}`);

            if (checkboxes.length === 0) {
                label.innerText = type === 'collab' ? 'Tous' : 'Toutes';
                label.classList.remove('font-bold', 'text-yellow-600');
            } else {
                label.innerText = `${checkboxes.length} sélectionné(s)`;
                label.classList.add('font-bold', 'text-yellow-600');
            }
            applyFilters();
        }

        function populateFilterDropdowns(data) {
            // Activities
            const activities = new Set();
            data.forEach(r => { if (r.activity) activities.add(r.activity); });

            const ddActivity = document.getElementById('dd-activity');
            ddActivity.innerHTML = '';

            // Add "Select All" option? Or just individual. Let's do individual sorted.
            Array.from(activities).sort().forEach(act => {
                const div = document.createElement('div');
                div.className = "flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer normal-case"; // Added normal-case
                div.innerHTML = `
                    <label class="flex items-center w-full cursor-pointer">
                        <input type="checkbox" value="${act}" class="form-checkbox h-4 w-4 text-yellow-500 rounded border-gray-300 mr-2" 
                            onchange="updateLabel('activity')">
                        <span class="text-xs text-gray-700">${act}</span>
                    </label>
                `;
                ddActivity.appendChild(div);
            });

            // Collaborators
            // SOURCE FROM MAP KEYS + DATA EMAILS to ensure EVERYONE is there
            const collabs = new Set(Object.keys(EMPLOYEE_NAMES).map(e => e.toLowerCase())); // Normalize Map keys
            data.forEach(r => { if (r.employee_email) collabs.add(r.employee_email.toLowerCase()); }); // Normalize Data keys

            const ddCollab = document.getElementById('dd-collab');
            ddCollab.innerHTML = '';

            Array.from(collabs).sort().forEach(email => {
                const name = formatName(email); // formatName handles case nicely
                const div = document.createElement('div');
                div.className = "flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer normal-case";
                div.innerHTML = `
                    <label class="flex items-center w-full cursor-pointer">
                        <input type="checkbox" value="${email}" class="form-checkbox h-4 w-4 text-yellow-500 rounded border-gray-300 mr-2" 
                            onchange="updateLabel('collab')">
                        <span class="text-xs text-gray-700">${name}</span>
                    </label>
                `;
                ddCollab.appendChild(div);
            });
        }

        // --- PAGINATION LOGIC ---
        function changePage(delta) {
            const maxPage = Math.ceil(currentFilteredData.length / pageSize) || 1;
            const newPage = currentPage + delta;

            if (newPage >= 1 && newPage <= maxPage) {
                currentPage = newPage;
                renderPaginatedTable();
            }
        }

        function renderPaginatedTable() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = currentFilteredData.slice(start, end);

            renderTable(pageData); // renderTable only renders what it is given

            // Update Controls
            document.getElementById('page-info').innerText = `Page ${currentPage} / ${Math.ceil(currentFilteredData.length / pageSize) || 1}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = currentPage >= (Math.ceil(currentFilteredData.length / pageSize) || 1);
            document.getElementById('record-count').innerText = `${currentFilteredData.length} résultats`;
        }

        // Update Date Filter Icon Style
        function updateDateFilterStyle() {
            const start = document.getElementById('filter-date-start').value;
            const end = document.getElementById('filter-date-end').value;
            const btn = document.querySelector('button[onclick="toggleDropdown(\'dd-date\')"]');

            if (start || end) {
                btn.classList.add('text-yellow-600', 'bg-yellow-50');
                btn.classList.remove('text-gray-500', 'hover:bg-gray-200');
            } else {
                btn.classList.remove('text-yellow-600', 'bg-yellow-50');
                btn.classList.add('text-gray-500', 'hover:bg-gray-200');
            }
        }

        // --- FILTERING LOGIC ---
        function applyFilters() {
            updateDateFilterStyle(); // Visual Feedback

            // Get selected multi-values (Already coerced to lowercase by populate)
            const selectedCollabs = Array.from(document.querySelectorAll('#dd-collab input:checked')).map(cb => cb.value);
            const selectedActivities = Array.from(document.querySelectorAll('#dd-activity input:checked')).map(cb => cb.value);

            const filters = {
                client: document.getElementById('filter-client').value.toLowerCase(),
                // collab: handled by selectedCollabs
                dateStart: document.getElementById('filter-date-start').value,
                dateEnd: document.getElementById('filter-date-end').value,
                // activity: handled by selectedActivities
                comment: document.getElementById('filter-comment').value.toLowerCase(),
                duration: document.getElementById('filter-duration').value,
                billable: document.getElementById('filter-billable').value,
                status: document.getElementById('filter-status').value.toLowerCase()
            };

            const filteredData = allTimesheets.filter(row => {
                // 0. Exclude PROBE/Ghost records
                if (row.comment && row.comment.startsWith('__PROBE')) return false;

                // 1. Strings (Includes)
                if (filters.client && (!row.client || !row.client.toLowerCase().includes(filters.client))) return false;

                // Collab (Multi-select)
                // If list is empty => ALL. If not empty => MUST be included.
                if (selectedCollabs.length > 0) {
                    if (!row.employee_email) return false;

                    const rowEmail = row.employee_email.toLowerCase().trim(); // added trim just in case
                    const match = selectedCollabs.includes(rowEmail);

                    // DEBUG: Log Sanadati specific failures
                    if (rowEmail.includes('sanadati') && !match) {
                        console.log('Sanadati Rejected:', { rowEmail, selectedCollabs });
                    }
                    if (rowEmail.includes('sanadati') && match) {
                        // console.log('Sanadati Accepted'); 
                    }

                    if (!match) return false;
                }

                // Activity (Multi-select)
                if (selectedActivities.length > 0 && !selectedActivities.includes(row.activity)) return false;

                // Comment
                if (filters.comment && (!row.comment || !row.comment.toLowerCase().includes(filters.comment))) return false;

                // Status
                if (filters.status && (!row.billing_status || !row.billing_status.toLowerCase().includes(filters.status))) return false;

                // 2. Date Range
                const rowDate = row.date ? row.date.split('T')[0] : '';
                if (filters.dateStart && rowDate < filters.dateStart) return false;
                if (filters.dateEnd && rowDate > filters.dateEnd) return false;

                // 3. Boolean (Billable)
                if (filters.billable !== "") { // "true" or "false" string from select
                    const isBillable = row.billable === true;
                    const filterBool = filters.billable === "true";
                    if (isBillable !== filterBool) return false;
                }

                // 4. Number (Duration in Hours)
                if (filters.duration) {
                    const rowHours = row.duration / 60; // duration in database is minutes
                    const inputStr = filters.duration.trim();
                    let op = '=';
                    let val = parseFloat(inputStr);

                    if (inputStr.startsWith('>')) { op = '>'; val = parseFloat(inputStr.substring(1)); }
                    else if (inputStr.startsWith('<')) { op = '<'; val = parseFloat(inputStr.substring(1)); }
                    else if (inputStr.startsWith('=')) { op = '='; val = parseFloat(inputStr.substring(1)); }

                    if (isNaN(val)) return true; // Ignore if invalid number

                    if (op === '>' && !(rowHours > val)) return false;
                    if (op === '<' && !(rowHours < val)) return false;
                    if (op === '=' && Math.abs(rowHours - val) > 0.01) return false; // Approx equality
                }

                return true;
            });

            // Sort explicitly by date descending (Newest first)
            filteredData.sort((a, b) => {
                const da = a.date ? new Date(a.date) : new Date(0);
                const db = b.date ? new Date(b.date) : new Date(0);
                return db - da;
            });

            // Update State
            currentFilteredData = filteredData;
            currentPage = 1; // Reset to first page
            renderPaginatedTable();
        }

        async function init() {
            // 1. Fetch ALL distinctive Filter Values (Collabs & Activities) - FAST
            // We do this separately to ensure the filters are COMPLETE even if we limit the data grid
            const [collabRes, activityRes] = await Promise.all([
                sbClient.from('timesheets').select('employee_email', { head: false, count: 'exact' }).not('employee_email', 'is', null).range(0, 100000), // Dumb way to get all, but simple. Or use .select DISTINCT equivalent logic via RPC or simple client side set from a specific query if possible. 
                // Creating a simplified distinct list via JS on client is safer for now without RPC.
                // Actually, let's just fetch ALL rows but only select updated columns.
                // Better: fetch a large CSV of just emails/activities.
                sbClient.from('timesheets').select('employee_email, activity').limit(100000)
            ]);

            // Process Distinct Values
            const allFilterRows = collabRes.data || []; // Actually I used activityRes for both.
            // Wait, I messed up the Promise.all logic above in the comment vs code.
            // Let's do a single query for filters: ID, email, activity.

            const { data: filterData } = await sbClient
                .from('timesheets')
                .select('employee_email, activity')
                .limit(100000); // Should cover everything for filters

            if (filterData) {
                // Populate Dropdowns with COMPLETE list
                populateFilterDropdowns(filterData);
            }

            // 2. Fetch Data Grid (BATCH FETCH to bypass 1000 row limit)
            let allRows = [];
            let from = 0;
            const batchSize = 1000; // API Max seems to be 1000
            let more = true;

            // Show loading status
            document.querySelector('#timesheet-body').innerHTML = `<tr><td colspan="7" class="text-center py-10">Chargement des données... (0 chargés)</td></tr>`;

            while (more) {
                const to = from + batchSize - 1;
                const { data, error } = await sbClient
                    .from('timesheets')
                    .select('*')
                    .order('date', { ascending: false })
                    .range(from, to);

                if (error) {
                    console.error("Batch Fetch Error", error);
                    break;
                }

                if (data && data.length > 0) {
                    allRows = allRows.concat(data);
                    // Update UI status
                    document.querySelector('#timesheet-body').innerHTML = `<tr><td colspan="7" class="text-center py-10">Chargement... (${allRows.length} lignes)</td></tr>`;

                    if (data.length < batchSize) {
                        more = false; // Last batch
                    } else {
                        from += batchSize;
                    }
                } else {
                    more = false;
                }

                // Safety break to prevent infinite loops if DB is huge (cap at 50k)
                if (allRows.length >= 50000) more = false;
            }

            const data = allRows; // Compatible with existing code logic

            // FILTER OUT GHOST/PROBE RECORDS GLOBALLY
            allTimesheets = data.filter(r => !r.comment || !r.comment.startsWith('__PROBE'));

            // DEBUG: DIAGNOSIS ON LOAD
            const debugEl = document.getElementById('debug-log');
            if (debugEl) {
                const sanaCount = allTimesheets.filter(r => r.employee_email && r.employee_email.toLowerCase().includes('sanadati')).length;
                debugEl.innerHTML = `
                    <div><strong>Diagnosis Report:</strong></div>
                    <div>Total Rows Loaded: ${allTimesheets.length} / ${data.length} (Raw)</div>
                    <div>Sanadati Rows in Memory: ${sanaCount}</div>
                    <div>User Filter Selection: ${JSON.stringify(Array.from(document.querySelectorAll('#dd-collab input:checked')).map(cb => cb.value))}</div>
                `;
            }

            document.querySelector('h2').innerText = `Suivi des Temps`; // Restore Clean Title

            // Note: populateFilterDropdowns was already called with filterData.
            // We do NOT need to call it again with 'data' unless we want to restrict filters to "visible data".
            // User wants "Sanadati" (who might be old) to appear. So we keep the FULL list.

            applyFilters();
            renderDashboard(allTimesheets);
        }

        function renderTable(rows) {
            const tbody = document.getElementById('timesheet-body');
            tbody.innerHTML = '';

            rows.forEach(row => {
                const tr = document.createElement('tr');
                const billableBadge = row.billable
                    ? `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Oui</span>`
                    : `<span class="text-gray-400 text-xs">—</span>`;

                tr.innerHTML = `
                    <td class="font-bold text-gray-900">${row.client || '-'}</td>
                    <td><span class="badge-collab">${formatName(row.employee_email)}</span></td>
                    <td class="text-gray-500 text-xs">${formatDate(row.date)}</td>
                    <td><span class="badge-activity">${row.activity || ''}</span></td>
                    <td class="text-gray-500 italic truncate max-w-xs" title="${row.comment || ''}">${row.comment || '-'}</td>
                    <td class="font-mono text-gray-700">${(row.duration / 60).toFixed(2)}</td>
                    <td class="text-center">${billableBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDashboard(rows) {
            // 1. KPIs & Aggregation
            let totalMins = 0;
            let billableCount = 0;
            let nonBillableMins = 0;
            const collaborators = new Set();
            const activityCount = {};
            const collabHours = {};
            const clientHours = {};
            const workDates = new Set();
            const evolution = {};

            rows.forEach(r => {
                const duration = r.duration || 0;
                totalMins += duration;
                if (r.billable) {
                    billableCount++;
                } else {
                    nonBillableMins += duration;
                }

                // Collab
                if (r.employee_email) {
                    collaborators.add(r.employee_email);
                    collabHours[r.employee_email] = (collabHours[r.employee_email] || 0) + duration;
                }

                // Activity
                const act = r.activity || 'Autre';
                activityCount[act] = (activityCount[act] || 0) + duration;

                // Client
                const client = r.client || 'Non Assigné';
                clientHours[client] = (clientHours[client] || 0) + duration;

                // Evolution (YYYY-MM)
                if (r.date) {
                    const monthKey = r.date.substring(0, 7); // 2024-01
                    evolution[monthKey] = (evolution[monthKey] || 0) + duration;
                }

                if (r.date) workDates.add(r.date.split('T')[0]);
            });

            // Find main client
            const mainClient = Object.entries(clientHours).length > 0
                ? Object.entries(clientHours).sort((a, b) => b[1] - a[1])[0][0]
                : '-';

            const totalHours = totalMins / 60;
            const nonBillableHours = nonBillableMins / 60;
            const billableRate = rows.length > 0 ? Math.round((billableCount / rows.length) * 100) : 0;

            document.getElementById('kpi-hours').innerText = Math.round(totalHours);
            document.getElementById('kpi-billable').innerText = billableRate + ' %';
            document.getElementById('kpi-collabs').innerText = collaborators.size;
            document.getElementById('kpi-non-billable').innerText = Math.round(nonBillableHours);
            document.getElementById('kpi-main-client').innerText = mainClient;
            document.getElementById('kpi-work-days').innerText = workDates.size;

            // --- CHART 1: Top Collabs ---
            const topCollabs = Object.entries(collabHours)
                .map(([email, mins]) => ({ email, hours: mins / 60 }))
                .sort((a, b) => b.hours - a.hours)
                .slice(0, 10);

            if (window.topCollabChart instanceof Chart) window.topCollabChart.destroy();
            window.topCollabChart = new Chart(document.getElementById('topCollabChart'), {
                type: 'bar',
                data: {
                    labels: topCollabs.map(c => formatName(c.email)),
                    datasets: [{
                        label: 'Heures',
                        data: topCollabs.map(c => c.hours),
                        backgroundColor: '#fbbf24',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // --- CHART 2: Activity ---
            const topActivities = Object.entries(activityCount)
                .map(([act, mins]) => ({ act, hours: mins / 60 }))
                .sort((a, b) => b.hours - a.hours)
                .slice(0, 5);

            if (window.activityChart instanceof Chart) window.activityChart.destroy();
            window.activityChart = new Chart(document.getElementById('activityChart'), {
                type: 'doughnut',
                data: {
                    labels: topActivities.map(a => a.act),
                    datasets: [{
                        data: topActivities.map(a => a.hours),
                        backgroundColor: ['#60a5fa', '#34d399', '#f87171', '#fbbf24', '#a78bfa']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // --- CHART 3: Top Clients ---
            const topClients = Object.entries(clientHours)
                .map(([client, mins]) => ({ client, hours: mins / 60 }))
                .sort((a, b) => b.hours - a.hours)
                .slice(0, 10);

            // Fix: Use correct element ID and window variable
            if (window.clientChart instanceof Chart) window.clientChart.destroy();
            window.clientChart = new Chart(document.getElementById('clientChart'), {
                type: 'bar',
                data: {
                    labels: topClients.map(c => c.client),
                    datasets: [{
                        label: 'Heures',
                        data: topClients.map(c => c.hours),
                        backgroundColor: '#8b5cf6', // Purple
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });

            // 4. Evolution Chart (Monthly)
            // Group by Month (YYYY-MM)
            const evolutionData = {};
            rows.forEach(r => {
                if (!r.date) return;
                const monthKey = r.date.substring(0, 7); // 2024-01
                if (!evolutionData[monthKey]) evolutionData[monthKey] = 0;
                evolutionData[monthKey] += (r.duration || 0);
            });

            const sortedMonths = Object.keys(evolutionData).sort();

            // Fix: Use CORRECT element ID 'evolutionChart' and variable window.evolutionChart
            if (window.evolutionChart instanceof Chart) window.evolutionChart.destroy();
            window.evolutionChart = new Chart(document.getElementById('evolutionChart'), {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Heures Totales',
                        data: sortedMonths.map(m => Math.round((evolutionData[m] / 60) * 10) / 10),
                        borderColor: '#10b981', // Green
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        init();
    </script>

</html>